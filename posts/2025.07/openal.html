<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方鹿的瞎玩日志∠( ᐛ 」∠)＿</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/go.min.js"></script>
    <link rel="stylesheet" href="/styles.css">
    <script>hljs.highlightAll();</script>
</head>
<body>
    <button class="toggle-sidebar" id="toggleSidebar">☰ 其他文章</button>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div id="sidebar-links">少女折寿中……</div>
        </div>

        <div class="content" id="content">
          <div class="cover" id="cover"></div>
          <h1 id="openal-中文教程或者叫openal笔记-1">OpenAL
中文教程（或者叫OpenAL笔记）</h1>
<p><del><em>不要退出QwQ， 我可以表演一下当猫娘喵。</em></del></p>
<p>U2B和B站都已经被OpenAI教程占领了，现在搜索OpenAL它会认为你拼错了……不管怎样，这是一个OpenAL的中文教程。</p>
<p><em>其实更像是笔记</em></p>
<h2 id="openal是做什么的">OpenAL是做什么的</h2>
<p>据我所知，是一个3D音频库，现在常见的一个开源实现是<a
href="https://github.com/kcat/openal-soft">OpenAL Soft</a>。</p>
<h2 id="一些概念">一些概念</h2>
<p>想象你现在正在一个大剧院里，大剧院当然有很多人。舞台上有演员，台下有观众，那么：</p>
<ul>
<li>演员：Source<br />
声音从哪里来？它可以拥有一个位置和一个方向，表明它正在向哪个方向播放音频。</li>
<li>观众：Listener<br />
你的耳朵在哪里？是一个位置。</li>
<li>音频内容：Buffer<br />
正在放什么？这个放着你的音频。</li>
</ul>
<h2 id="数据类型">数据类型</h2>
<p>和OpenGL非常相似。</p>
<table>
<thead>
<tr class="header">
<th>OpenAL</th>
<th>OpenALC</th>
<th>OpenGL</th>
<th>C++</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ALboolean</td>
<td>ALCboolean</td>
<td>GLboolean</td>
<td>std::int8_t</td>
</tr>
<tr class="even">
<td>ALbyte</td>
<td>ALCbyte</td>
<td>GLbyte</td>
<td>std::int8_t</td>
</tr>
<tr class="odd">
<td>ALubyte</td>
<td>ALCubyte</td>
<td>GLubyte</td>
<td>std::uint8_t</td>
</tr>
<tr class="even">
<td>ALchar</td>
<td>ALCchar</td>
<td>GLchar</td>
<td>char</td>
</tr>
<tr class="odd">
<td>ALshort</td>
<td>ALCshort</td>
<td>GLshort</td>
<td>std::int16_t</td>
</tr>
<tr class="even">
<td>ALushort</td>
<td>ALCushort</td>
<td>GLushort</td>
<td>std::uint16_t</td>
</tr>
<tr class="odd">
<td>ALint</td>
<td>ALCint</td>
<td>GLint</td>
<td>std::int32_t</td>
</tr>
<tr class="even">
<td>ALuint</td>
<td>ALCuint</td>
<td>GLuint</td>
<td>std::uint32_t</td>
</tr>
<tr class="odd">
<td>ALsizei</td>
<td>ALCsizei</td>
<td>GLsizei</td>
<td>std::int32_t</td>
</tr>
<tr class="even">
<td>ALenum</td>
<td>ALCenum</td>
<td>GLenum</td>
<td>std::uint32_t</td>
</tr>
<tr class="odd">
<td>ALfloat</td>
<td>ALCfloat</td>
<td>GLfloat</td>
<td>float</td>
</tr>
<tr class="even">
<td>ALdouble</td>
<td>ALCdouble</td>
<td>GLdouble</td>
<td>double</td>
</tr>
<tr class="odd">
<td>ALvoid</td>
<td>ALCvoid</td>
<td>GLvoid</td>
<td>void</td>
</tr>
</tbody>
</table>
<h2 id="所以openalc是什么">所以OpenALC是什么？</h2>
<p>它是Open Audio Library
Context（直译：开源音频库上下文）。它管你用什么东西播放音频，比如你的扬声器或者是耳机。而OpenAL不管这些。</p>
<h2 id="关于加载音频">关于加载音频</h2>
<p>OpenAL不提供这样的功能（就像OpenGL不提供图像加载一样），你需要自己想其他办法。加载wav可以用<a
href="https://github.com/adamstark/AudioFile">这个</a>，ogg可以用<a
href="https://github.com/adamstark/AudioFile">这个</a>或者<a
href="https://xiph.org/downloads/">libogg和libvorbis</a>。</p>
<h2 id="开始吧">开始吧</h2>
<p>首先你需要打开音频设备：</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;AL/al.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;AL/alc.h&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>ALCdevice <span class="op">*</span>device <span class="op">=</span> alcOpenDevice<span class="op">(</span><span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>device <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 打开失败</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code class="verbatim">nullptr</code> 或者 <code
class="verbatim">NULL</code> 参数表示使用系统的默认音频设备。</p>
<p>和OpenGL一样，你需要一个上下文。不过OpenAL的更简单一些：</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ALCcontext <span class="op">*</span>context <span class="op">=</span> alcCreateContext<span class="op">(</span>device<span class="op">,</span> <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>context <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 失败</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>关于 <code class="verbatim">alcCreateContext</code>
的第二个参数，它是用于指定属性的列表：</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> ALCint attrib_list<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  ALC_FREQUENCY<span class="op">,</span> <span class="dv">44100</span><span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  ALC_REFRESH<span class="op">,</span> <span class="dv">60</span><span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  ALC_SYNC<span class="op">,</span> ALC_FALSE<span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span> <span class="co">// 你需要一个0来终止列表</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>ALCcontext <span class="op">*</span>context <span class="op">=</span> alcCreateContext<span class="op">(</span>device<span class="op">,</span> attrib_list<span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>context <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 失败</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>下面是一些属性：</p>
<table>
<thead>
<tr class="header">
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ALC_FREQUENCY</td>
<td>输出Buffer的频率，以赫兹(Hz)为单位（例如44100）</td>
</tr>
<tr class="even">
<td>ALC_REFRESH</td>
<td>刷新间隔，以赫兹(Hz)为单位</td>
</tr>
<tr class="odd">
<td>ALC_SYNC</td>
<td>如果为真，上下文将会是同步的（而非异步的），通常我们用 <code
class="verbatim">ALC_FALSE</code></td>
</tr>
<tr class="even">
<td>ALC_MONO_SOURCES</td>
<td>分配的单声道音源数量</td>
</tr>
<tr class="odd">
<td>ALC_STEREO_SOURCES</td>
<td>和上面一样，只不过是立体声</td>
</tr>
</tbody>
</table>
<p>注意：这些只是请求，实际可能不是你指定的那样。</p>
<p>将上下文设置成当前上下文：</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>alcMakeContextCurrent<span class="op">(</span>context<span class="op">))</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 失败</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>当然，我们用完了得释放资源，在你的程序最后加上：</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>alcDestroyContext<span class="op">(</span>context<span class="op">);</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>alcCloseDevice<span class="op">(</span>device<span class="op">);</span></span></code></pre></div>
<h2 id="准备buffer">准备Buffer</h2>
<p>首先我们得告诉OpenAL我们需要一个Buffer，生成Buffer我们需要用到函数alGenBuffers：</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ALuint buffer<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>alGenBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>buffer<span class="op">);</span></span></code></pre></div>
<p>和OpenGL一样，第一个参数是我们要生成的数量，这里我们只要一个，所以我们填1；第二个参数是一个指向ID的指针，所以我们把buffer变量取地址传进去。</p>
<h2 id="错误处理">错误处理</h2>
<p>如果你想要知道哪里发生了错误……使用 <code
class="verbatim">alGetError</code>
，和OpenGL一样，它会返回一个整数错误码，0表示没有错误。其他常见的值如下：</p>
<table>
<thead>
<tr class="header">
<th>标识</th>
<th>描述</th>
<th>数值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AL_NO_ERROR</td>
<td>(0)没有错误</td>
<td>0</td>
</tr>
<tr class="even">
<td>AL_INVALID_NAME</td>
<td>传进去的ID不合法</td>
<td>0xA001(40961)</td>
</tr>
<tr class="odd">
<td>AL_INVALID_ENUM</td>
<td>传进去了一个不合法的枚举</td>
<td>0xA002(40962)</td>
</tr>
<tr class="even">
<td>AL_INVALID_VALUE</td>
<td>值不合法</td>
<td>0xA003(40963)</td>
</tr>
<tr class="odd">
<td>AL_INVALID_OEPRATION</td>
<td>请求的操作不合法（比如错误的上下文状态）</td>
<td>0xA004(40964)</td>
</tr>
<tr class="even">
<td>AL_OUT_OF_MEMORY</td>
<td>正如其名，（声卡）内存不足</td>
<td>0xA005(40965)</td>
</tr>
</tbody>
</table>
<p>注意：当它被调用的时候，它会清除所有错误标记。换言之，如果返回了一个错误，你无法确定那是唯一的一个标记。</p>
<h2 id="加载音频">加载音频</h2>
<p>这需要用音频库，我这里用 <code class="verbatim">stb_vorbis.c</code>
：</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 在另一个头文件里写 stb_vorbis.h</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define STB_VORBIS_HEADER_ONLY</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;stb_vorbis.c&quot;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 你的main.cpp</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;stb_vorbis.h&quot;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> length<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> channels<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sample_rate<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> error<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">// 加载的ogg文件路径</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>string file_name <span class="op">=</span> <span class="st">&quot;./test.ogg&quot;</span><span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>stb_vorbis <span class="op">*</span>vorbis <span class="op">=</span> stb_vorbis_open_filename<span class="op">(</span>file_name<span class="op">.</span>c_str<span class="op">(),</span> <span class="op">&amp;</span>error<span class="op">,</span> <span class="kw">nullptr</span><span class="op">);</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>vorbis <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>cerr <span class="op">&lt;&lt;</span> <span class="st">&quot;打开OGG文件失败: &quot;</span> <span class="op">&lt;&lt;</span> file_name <span class="op">&lt;&lt;</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>stb_vorbis_info info <span class="op">=</span> stb_vorbis_get_info<span class="op">(</span>vorbis<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>channels <span class="op">=</span> info<span class="op">.</span>channels<span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>sample_rate <span class="op">=</span> info<span class="op">.</span>sample_rate<span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co">// 总样本数</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> total_samples <span class="op">=</span>   stb_vorbis_stream_length_in_samples<span class="op">(</span>vorbis<span class="op">);</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>length <span class="op">=</span> total_samples <span class="op">*</span> info<span class="op">.</span>channels<span class="op">;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">short</span><span class="op">&gt;</span> data<span class="op">(</span>length<span class="op">);</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co">// 解码实际数据</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> samples_decoded <span class="op">=</span> stb_vorbis_get_samples_short_interleaved<span class="op">(</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    vorbis<span class="op">,</span> info<span class="op">.</span>channels<span class="op">,</span> data<span class="op">.</span>data<span class="op">(),</span> length<span class="op">);</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">((</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">)</span>samples_decoded <span class="op">&lt;</span> total_samples<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>cerr <span class="op">&lt;&lt;</span> <span class="st">&quot;Warning: did not decode all samples</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>stb_vorbis_close<span class="op">(</span>vorbis<span class="op">);</span></span></code></pre></div>
<p>我们暂时只需要其中的channels数量和每sample位数，而stb_vorbis解码为16位PCM。</p>
<p>为什么vector的元素类型是short：因为16位数字占两个字节，而在大多数平台上，short类型是两字节的。</p>
<h2 id="检查音频数据的格式">检查音频数据的格式</h2>
<p>接下来你需要检查音频数据的格式，告诉OpenAL如何处理你的数据：</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 上面已经提到了，在不进行特别修改的情况下，</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// stb_vorbis只能解码为16位PCM，所以我这里直接写成常量</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="dt">int</span> bits_per_sample <span class="op">=</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>ALenum format<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>channels <span class="op">==</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> bits_per_sample <span class="op">==</span> <span class="dv">8</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  format <span class="op">=</span> AL_FORMAT_MONO8<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>channels <span class="op">==</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> bits_per_sample <span class="op">==</span> <span class="dv">16</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  format <span class="op">=</span> AL_FORMAT_MONO16<span class="op">;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>channels <span class="op">==</span> <span class="dv">2</span> <span class="op">&amp;&amp;</span> bits_per_sample <span class="op">==</span> <span class="dv">8</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  format <span class="op">=</span> AL_FORMAT_STEREO8<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>channels <span class="op">==</span> <span class="dv">2</span> <span class="op">&amp;&amp;</span> bits_per_sample <span class="op">==</span> <span class="dv">16</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  format <span class="op">=</span> AL_FORMAT_STEREO16<span class="op">;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 未知格式</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>声音数据是这样的：我们有一个或者多个通道（一个勉强的解释是：你的耳朵数量大于1），而每个sample有很多位，数据由sample组成。</p>
<p>以及，为了满足你的好奇心。英语中mono表示单声道，stereo表示立体声。</p>
<h2 id="总sample数的计算">总sample数的计算</h2>
<p>事实上，如果你只是跟着我提供的这个例子做的话，你不需要算这两个东西。直接跳到<span
class="spurious-link" target="* 上传数据，填充Buffer"><em>*
上传数据，填充Buffer</em></span>就可以了。</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> number_of_samples <span class="op">=</span> data_size <span class="op">/</span> <span class="op">(</span>number_of_channels <span class="op">*</span> <span class="op">(</span>bits_per_sample <span class="op">/</span> <span class="dv">8</span><span class="op">));</span></span></code></pre></div>
<h2 id="总时长的计算">总时长的计算</h2>
<div class="sourceCode" id="cb10"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> duration <span class="op">=</span> number_of_samples <span class="op">/</span> sample_rate<span class="op">;</span></span></code></pre></div>
<h2 id="上传数据填充buffer">上传数据，填充Buffer</h2>
<p>现在我们终于可以上传数据了：</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>alBufferData<span class="op">(</span>buffer<span class="op">,</span> format<span class="op">,</span> data<span class="op">.</span>data<span class="op">(),</span> data<span class="op">.</span>size<span class="op">()</span> <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">short</span><span class="op">),</span> sample_rate<span class="op">);</span></span></code></pre></div>
<h2 id="我们还需要一个source">我们还需要一个Source</h2>
<p>别忘了OpenAL是一个3D音频库，所以我们还需要一个喇叭。</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 生成Source</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ALuint source<span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>alGenSources<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>source<span class="op">);</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">// 设置属性</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>alSourcef<span class="op">(</span>source<span class="op">,</span> AL_PITCH<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>alSourcef<span class="op">(</span>source<span class="op">,</span> AL_GAIN<span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>alSource3f<span class="op">(</span>source<span class="op">,</span> AL_POSITION<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>alSource3f<span class="op">(</span>source<span class="op">,</span> AL_VELOCITY<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>alSourcei<span class="op">(</span>source<span class="op">,</span> AL_LOOPING<span class="op">,</span> AL_FALSE<span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>alSourcei<span class="op">(</span>source<span class="op">,</span> AL_BUFFER<span class="op">,</span> buffer<span class="op">);</span></span></code></pre></div>
<p>你可以看到一些东西，比如我们的位置( <code
class="verbatim">AL_POSITION</code> )，和喇叭的朝向( <code
class="verbatim">AL_VELOCITY</code> )。</p>
<p>解释一下其余东西：</p>
<ul>
<li><code class="verbatim">AL_LOOPING</code>
：它表示是否循环播放，这里我们不需要，所以设置假。</li>
<li><code class="verbatim">AL_GAIN</code>
：一个更常见的名字是音量。这里我们设置1.0。</li>
<li><code class="verbatim">AL_BUFFER</code>
：这很明显了，不解释它了。</li>
</ul>
<h1 id="播放声音">播放声音</h1>
<div class="sourceCode" id="cb13"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>alSourcePlay<span class="op">(</span>source<span class="op">);</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ALint state <span class="op">=</span> AL_PLAYING<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>state <span class="op">==</span> AL_PLAYING<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  alGetSourcei<span class="op">(</span>source<span class="op">,</span> AL_SOURCE_STATE<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>我们调用 <code class="verbatim">alSourcePlayer</code>
开始播放Source。然后我们准备一个用来存储 <code
class="verbatim">AL_SOURCE_STATE</code>
的东西。然后在循环中更新它的值。这样就可以等待它播放完成（变成 <code
class="verbatim">AL_STOPPED</code> ）。</p>
<h2 id="清理">清理</h2>
<p>我们已经讲过关闭设备和上下文了。我们还有一个Source和Buffer需要清理：</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>alDeleteSource<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>source<span class="op">);</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>alDeleteBuffers<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>buffer<span class="op">);</span></span></code></pre></div>
<blockquote>
<p>警告：尽量不要尝试放歌曲。这些代码只是把音频整个解码到内存中再播放。这样对于较长的文件（比如完整的歌曲）是有问题的，一个是加载时间长。第二个是占内存太大了（实测5分钟音乐能占120MB左右的内存）。后面我们会介绍其他方法来播放歌曲。</p>
</blockquote><!--从这里插入Markdown转来的部分-->
          <footer>
            <p>© BlockyDeer 2024-2025</p>
          </footer>
        </div>
    </div>
    <button class="back-to-top" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">点我回家</button>
    <script src="/script.js"></script>
</body>
</html>
